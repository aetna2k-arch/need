
















.checkbox-custom:checked + label { background-color: #065f46; color: white; border-color: #065f46; }
    </風格>
</頭>
<身體 班級=“抗鋸齒 PB-10”>

<div ID="應用程式" 班級=“min-h-screen”>
    <!-- 導覽列 -->
    <不 班級="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 px-6 h-16 flex items-center justify-between shadow-sm">
        <div 班級="flex items-center gap-2">
            <div 班級="w-8 h-8 bg-mudan rounded-lg flex items-center justify-center text-white font-black italic">M</div>
            <跨距 班級="font-black text-emerald-900 tracking-tight">牡丹古道調查</跨距>
        </div>
        <button id="admin-trigger" class="p-2 text-emerald-700 bg-emerald-50 rounded-full hover:bg-emerald-100 transition-colors">
            <i data-lucide="lock" class="w-4 h-4"></i>
        </button>
    </nav>

    <main class="max-w-2xl mx-auto mt-6 px-4">
        <!-- 問卷區 -->
        <div id="survey-container">
            <div class="bg-white rounded-3xl card-shadow overflow-hidden border border-emerald-50">
                <div class="bg-mudan p-8 text-white">
                    <h1 class="text-2xl font-black mb-2">走讀相關調查表</h1>
                    <p class="text-emerald-50/80 text-xs">您的回饋是我們前進的動力</p>
                </div>

                <form id="feedback-form" class="p-6 space-y-8">
                    <!-- 1. 基本資料 -->
                    <div class="space-y-4">
                        <label class="block text-sm font-black text-emerald-900 flex items-center gap-2">
                            <span class="w-5 h-5 bg-emerald-100 text-emerald-700 rounded-full flex items-center justify-center text-[10px]">1</span>
                            基本資料
                        </label>
                        <input type="text" name="user_name" required placeholder="請輸入姓名 *" class="w-full p-4 bg-gray-50 border-2 border-transparent focus:border-emerald-500 rounded-2xl transition-all outline-none">
                        
                        <div class="pt-2">
                            <p class="text-[13px] font-bold text-gray-500 mb-3">解說背景或相關專長 (若無則不需勾選)</p>
                            <div class="grid grid-cols-2 gap-2" id="spec-list"></div>
                            <input type="text" id="spec-other-input" placeholder="請輸入其他專長" class="hidden w-full mt-2 p-3 bg-white border-2 border-emerald-100 rounded-xl text-sm">
                        </div>
                    </div>

                    <!-- 2. 評分 -->
                    <div class="space-y-6">
                        <label class="block text-sm font-black text-emerald-900 flex items-center gap-2">
                            <span class="w-5 h-5 bg-emerald-100 text-emerald-700 rounded-full flex items-center justify-center text-[10px]">2</span>
                            專業評核 (1分最低 - 5分最高)
                        </label>
                        <div id="rating-container" class="space-y-6"></div>
                    </div>

                    <!-- 3. 定價 -->
                    <div class="p-5 bg-emerald-50/50 rounded-2xl space-y-4">
                        <p class="text-sm font-bold text-emerald-900">理想收費價格建議 (成本約 450 元)</p>
                        <div id="price-list" class="space-y-2"></div>
                        <input type="text" id="price-other-input" placeholder="請輸入建議金額與原因" class="hidden w-full p-3 bg-white border-2 border-emerald-200 rounded-xl text-sm">
                    </div>

                    <!-- 4. 意願 -->
                    <div class="space-y-4">
                        <p class="text-sm font-bold text-emerald-900">未來帶團/行程合作意願</p>
                        <div id="intent-list" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- 5. 建議 -->
                    <div class="space-y-4">
                        <label class="block text-sm font-black text-emerald-900 flex items-center gap-2">
                            <span class="w-5 h-5 bg-emerald-100 text-emerald-700 rounded-full flex items-center justify-center text-[10px]">3</span>
                            綜合建議
                        </label>
                        <input type="text" name="highlight" required placeholder="印象最深刻的事項 (一句話)" class="w-full p-4 bg-gray-50 border-2 border-transparent focus:border-emerald-500 rounded-2xl outline-none">
                        <textarea name="comment" required placeholder="其他建議與觀察回饋" class="w-full p-4 bg-gray-50 border-2 border-transparent focus:border-emerald-500 rounded-2xl h-32 outline-none"></textarea>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full bg-mudan text-white py-4 rounded-2xl font-black text-lg shadow-lg btn-hover shadow-emerald-900/20">確認送出</button>
                </form>
            </div>
        </div>

        <!-- 管理後台 -->
        <div id="admin-container" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-3xl border flex justify-between items-center shadow-sm">
                <div>
                    <h2 class="font-black text-lg">數據後台</h2>
                    <p id="data-count" class="text-xs text-gray-400">目前共 0 筆資料</p>
                </div>
                <button onclick="exportCSV()" class="bg-emerald-800 text-white px-4 py-2 rounded-xl text-xs font-bold">下載 CSV</button>
            </div>
            <div id="entries-list" class="space-y-3"></div>
            <button onclick="location.reload()" class="w-full py-4 text-gray-400 text-sm font-bold">返回問卷</button>
        </div>
    </main>

    <!-- 登入彈窗 -->
    <div id="login-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 w-full max-w-xs shadow-2xl">
            <h3 class="text-center font-black mb-6">管理員登入</h3>
            <input type="password" id="admin-pass" placeholder="請輸入密碼" class="w-full p-4 bg-gray-100 rounded-2xl mb-4 text-center outline-none border-2 border-transparent focus:border-emerald-500">
            <div class="flex gap-2">
                <button onclick="closeLogin()" class="flex-1 py-3 font-bold text-gray-400">取消</button>
                <button onclick="doLogin()" class="flex-1 py-3 bg-mudan text-white rounded-2xl font-bold">登入</button>
            </div>
        </div>
    </div>
</div>

<script>
    let db;
    let auth;
    let user = null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'mudan-survey-v4-active';
    
    // 初始化 UI
    async function init() {
        lucide.createIcons();
        renderOptions();
        
        // Firebase 初始化與身份驗證
        嘗試 {
            if (typeof __firebase_config !== 'undefined') {
                const config = JSON.parse(__firebase_config);
                firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();

                // 核心修復：在執行任何 Firestore 操作前先進行驗證
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };

                await initAuth();
                auth.onAuthStateChanged((u) => {
                    user = u;
                    console.log("Auth State Changed: ", u ? "Logged In" : "Logged Out");
                });
            }
        } catch (e) { 
            console.error("Firebase Initialization Error:", e); 
        }

        document.getElementById('feedback-form').onsubmit = handleSubmit;
        document.getElementById('admin-trigger').onclick = () => document.getElementById('login-modal').classList.remove('hidden');
    }

    function renderOptions() {
        const specs = ["生態解說", "歷史人文", "自然地理", "環境教育", "其他"];
        document.getElementById('spec-list').innerHTML = specs.map(s => `
            <div>
                <input type="checkbox" name="spec" value="${s}" id="s-${s}" class="sr-only checkbox-custom" onchange="toggleSpecOther(this)">
                <label for="s-${s}" class="block p-3 border-2 border-gray-100 rounded-xl text-center text-xs font-bold text-gray-400 cursor-pointer transition-all">${s}</label>
            </div>
        `).join('');

        const ratings = [
            { id: 'res', label: '場域教育資源豐富度' },
            { id: 'flow', label: '行程動線行走舒適度' },
            { id: 'food', label: '餐飲內容在地滿意度' }
        ];
        document.getElementById('rating-container').innerHTML = ratings.map(r => `
            <div>
                <p class="text-xs font-bold text-emerald-700 mb-3">${r.label}</p>
                <div class="flex gap-1">
                    ${[1,2,3,4,5].map(v => `
                        <label class="flex-1">
<input type="radio" name="score_${r.ID}"值="${在}"必需類別="僅限 r 的對等體">
<div class="py-3 text-center border-2 border-gray-100 rounded-xl peer-checked:bg-emerald-700 peer-checked:text-white peer-checked:border-emerald-700 text-gray-300 font-black cursor-pointer">${在}</div>
</label>
                    `).加入('')}
</div>
</div>
        `).加入('');

        常量 價格 = ["450元(基本成本)", "600-750元 (專業補貼)", "800-1000元 (市場行情)", "其他"];
        文件.getElementById(價格表).內部 HTML = 價格.地圖(p => `
<label class="flex items-center gap-3 p-3 bg-white rounded-xl border-2 border-transparent hover:border-emerald-200 cursor-pointer">
<input type="radio" name="price" value="${p}" required onchange="togglePriceOther(this.value)" class="w-4 h-4 accent-emerald-600">
<span class="text-sm font-bold text-gray-600">${p}</span>
</label>
        `).加入('');

        常量 意圖 = ["願意帶團", "評估考慮", "暫無意願"];
        文件.getElementById('意圖列表').內部 HTML = 意圖.地圖(我 => `
<label class="px-5 py-2 border-2 border-gray-100 rounded-full cursor-pointer has-[:checked]:bg-emerald-100 has-[:checked]:border-emerald-500 transition-all">
<input type="radio" name="intent" value="${我}"必需類別="r-only">
<span class="text-xs font-bold text-gray-500">${我}</span>
</label>
        `).加入('');
    }

    function toggleSpecOther(el) {
        if(el.value === '其他') document.getElementById('spec-other-input').classList.toggle('hidden', !el.checked);
    }
    function togglePriceOther(v) {
        document.getElementById('price-other-input').classList.toggle('hidden', v !== '其他');
    }
    功能 關閉登入() { 文件.getElementById('登入模態框').類別列表.添加('隱'); }






        }


        按鈕.已停用 = 真的;
        按鈕.內部文字 = "儲存中...";



        如果(規格.包括('其他')) 規格.推("備註:"+文件.getElementById('spec-other-input').價值);


            姓名: fd.得到('使用者名稱'),
            規格: 規格,
            得分: {
                餘: fd.得到('score_res'),
                流動: fd.得到('score_flow'),
                食物: fd.得到('score_food')
            },
            價格: fd.得到('價格') === '其他' ? fd.得到('價格-其他投入') : fd.得到('價格'),
            意圖: fd.得到('意圖'),
            強調: fd.得到('強調'),
            評論: fd.得到('評論'),
            時間: 新的日期().轉換為ISO字串()
        };

        嘗試{
            // 修正：使用規範要求的路徑
            常數列引用 = 檔案.收藏(“人工製品”).文件(appId).收藏('民眾').文件('數據').收藏(“回應”);
            等待列引用.添加(有效載荷);
            警報("感謝您的填寫！回饋已成功送出。");

        } 抓住 (犯錯) {




        }
    }








    }



        








            }
        });
    }








</div>





</div>
</div>
        
    }






        ]);






    }




